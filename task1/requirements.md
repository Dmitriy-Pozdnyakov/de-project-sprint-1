# Построить витрину для RFM-анализа
RFM (от англ. Recency, Frequency, Monetary Value).

Каждого клиента оценивают по трём факторам:

- Recency (пер. «давность») — сколько времени прошло с момента последнего заказа.
- Frequency (пер. «частота») — количество заказов.
- Monetary Value (пер. «денежная ценность») — сумма затрат клиента.
## Выяснить требования к целевой витрине
Требуется создать витрину **dm_rfm_segments** в схеме analysis с полями:

- user_id
- recency (число от 1 до 5)
- frequency (число от 1 до 5)
- monetary_value (число от 1 до 5)

**Требования к глубине данных:** накопительно с 2022 года.

**Требования к логике отбора:** при разработке витрины использовать заказы со статусом Closed. (успешный заказ)

## Изучитить структуру исходных данных
Для расчета витрины в рамках 1 задания использовались следующие данные:

| Таблица                | Поле     | Описание                          | 
| ---------------------- | -------- | --------------------------------- | 
| analysis.users         | id       | Ид. пользователя                  | 
| analysis.orders        | order_id | Ид. заказа                        | 
| analysis.orders        | order_ts | Дата и время заказа               | 
| analysis.orders        | payment  | Платеж клиента                    | 
| analysis.orders        | status   | Статус заказа в числовом формате  | 
| analysis.orderstatuses | key      | Статус заказа в текстовом формате |

Для второго задания после изменения структуры данных использовалась дополнительно таблица:
| Таблица                  | Поле     | Описание                          | 
| -------------------------|----------| --------------------------------- | 
| production.orderstatuslog| status_id| Ид. статуса                       | 
| production.orderstatuslog| dttm     | Дата и время изменения статуса    | 


При подготовке витрины была проведен анализ качества данных, результаты представлены в **файле task1/data_quality.md**

## В рамках подготовки витрины
1. **Сделать представление для таблиц из базы production:** 
- task1/views.sql
2. **Написать DDL-запрос для создания витрин:**  
- task1/datamart_ddl.sql
3. **Написать SQL-запрос для создания таблиц с метриками:**  
- task1/tmp_rfm_recency.sql,  
- task1/tmp_rfm_frequency.sql,  
- task1/tmp_rfm_monetary_value.sql
4. **Собрать витрину dm_rfm_segments:**  
- task1/datamart_query.sql
5. **Рефакторинг сборки таблицы analysis.orders:** 
- task2/orders_view.sql
